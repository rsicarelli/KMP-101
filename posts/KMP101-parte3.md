> * [Introdu√ß√£o ao compilador do Kotlin](#introdu√ß√£o-ao-compilador-do-kotlin)
> * [Entendendo o Frontend do compilador do Kotlin](#entendendo-o-frontend-do-compilador-do-kotlin)
>   * [K1: codinome FE10 (Frontend 1.0)](#k1-codinome-fe10-frontend-10)
>   * [K2: codinome FIR (Frontend Intermediate Representation)](#k2-codinome-fir-frontend-intermediate-representation)
> * [Entendendo o Backend do compilador do Kotlin](#entendendo-o-backend-do-compilador-do-kotlin)
> * [Representa√ß√£o Intermedi√°ria ou Intermediary Representation (IR)](#representa√ß√£o-intermedi√°ria-ou-intermediary-representation-ir)

No √∫ltimo artigo (üîó [KMP 101: Entendendo como o Kotlin compila para multiplas plataformas](https://dev.to/rsicarelli/kotlin-multiplataforma-101-entendendo-como-o-kotlin-compila-para-multiplas-plataformas-5hba)), aprendemos sobre o frontend, IR e backend do compilador do Kotlin.

Dessa vez, vamos entender um conceito chave para codar em KMP: os `source sets` 

---

## Introdu√ß√£o aos `source sets` do KMP

Os *source sets* no Kotlin s√£o essenciais para o desenvolvimento multiplataforma. Utilizando uma arquitetura hier√°rquica, os source sets nos permite organizar nosso c√≥digo-fonte, declarar dep√™ndencias espec√≠ficas para cada alvo, e tamb√©m de nos permite configurar op√ß√µes de compila√ß√£o de forma isolada para diferentes plataformas em um mesmo projeto.

Pense em um *source set* no KMP como uma "pasta especial" em um projeto, onde cada pasta t√™m um prop√≥sito (ou plataforma) espec√≠fica. Por exemplo, a pasta "comum" cont√©m arquivos usados em todas as plataformas, enquanto pastas espec√≠ficas, como "android" ou "iOS", abrigam arquivos exclusivos para essas plataformas.

O compilador do Kotlin identifica essas pastas especiais e se encarrega de compilar seu conte√∫do (c√≥digo-fonte), conforme as estrat√©gias de compila√ß√£o exploradas em üîó [KMP 101: Entendendo como o Kotlin compila para multiplas plataformas](https://dev.to/rsicarelli/kotlin-multiplataforma-101-entendendo-como-o-kotlin-compila-para-multiplas-plataformas-5hba).

### Estrutura b√°sica de um source set

Cada *source set* em um projeto multiplataforma possui **um nome √∫nico** e cont√©m um conjunto de arquivos de c√≥digo-fonte e recursos (arquivos, √≠cones, etc). Ele especifica **um alvo** (target) para o qual o c√≥digo ser√° compilado.

Assumindo que as configura√ß√µes necess√°rias foram aplicadas (iremos abordada-las em artigos futuros), a estrutura de pastas abaixo orienta o compilador do Kotlin a:

1. Inicializar e compilar os seguintes alvos: `android`, `iOS`, `watchOS`, `tvOS`, `js`, `wasm` e `desktop`.
2. Compilar o c√≥digo-fonte dentro do source set `common` para todas as plataformas, tornando os membros do arquivo `Common.kt` dispon√≠veis nativamente para cada plataforma definida.
3. Ao final da compila√ß√£o, gerar arquivos espec√≠ficos para cada plataforma (`.class`, `.so`, `.js`, `.wasm`), com todos os membros do `Common.kt` dispon√≠veis.

![Desenvolvimento nativo](https://github.com/rsicarelli/KMP-101/blob/main/posts/assets/kmp101-sourcesets-basic.png?raw=true)

### A natureza hier√°rquica dos source sets
Os source sets do KMP funcionam como uma √°rvore geneal√≥gica. 

Na base da √°rvore, temos os ancestrais comuns (o source set `commonMain`), cujas caracter√≠sticas s√£o compartilhadas por todos na fam√≠lia. √Ä medida que avan√ßamos para os galhos, encontramos os source sets intermedi√°rios, que representam ramos da fam√≠lia com caracter√≠sticas √∫nicas compartilhadas por um subconjunto de membros (por exemplo, `apple` ou `native`). 

Finalmente, nas extremidades dos galhos, est√£o os membros individuais da fam√≠lia (os source sets espec√≠ficos da plataforma, como `iosArm64` ou `iosSimulatorArm64`), cada um com suas pr√≥prias caracter√≠sticas √∫nicas.

Isso permite organizar uma hierarquia de *source sets* intermedi√°rios com total controle do que cada source set ir√° compartilhar.

![Source sets intermedi√°rios KMP](https://github.com/rsicarelli/KMP-101/blob/main/posts/assets/intermediate-source-sets-diagram.png?raw=true)

#### Hierarquia padr√£o

A partir do Kotlin `1.9.20`, o plugin Gradle do KMP oferece **um modelo de hierarquia padr√£o**, que cont√©m *source sets* intermedi√°rios predefinidos para casos de uso comuns. Esse modelo √© automaticamente configurado com base nos alvos especificados no projeto. 

Um exemplo interessante √© que os *source sets* `apple` e `native` compilam apenas para os alvos `iosArm64` e `iosSimulatorArm64`, mas t√™m acesso √† API completa do iOS. Essa abordagem hier√°rquica oferece flexibilidade e controle detalhado sobre como o c√≥digo √© compartilhado e utilizado entre diferentes plataformas e alvos.

![Hierarquia padr√£o do KMP](https://kotlinlang.org/docs/images/default-hierarchy-example.svg)

### Exemplo: compartilhando uma interface entre source sets

Vamos supor que temos um projeto KMP com os source sets `commonMain`, `androidMain` e `appleMain`. Dentro do source set com√∫m, temos uma interface definida chamada `InterfaceComum` que funciona como um contrato que todas as plataformas precisam aderir.  

Derivando da `InterfaceComum`, temos `InterfaceApple` e `InterfaceAndroid`: a `InterfaceApple` adiciona funcionalidades espec√≠ficas para o ecossistema Apple, enquanto `InterfaceAndroid` faz o mesmo para dispositivos Android. Esse design garante que, embora compartilhemos a l√≥gica comum pela `InterfaceComum`, cada plataforma pode ter suas pr√≥prias extens√µes e funcionalidades, mantendo a separa√ß√£o e a especializa√ß√£o do c√≥digo conforme necess√°rio.

![Mermaid](mermaid-diagram-2023-11-24-110205)

### Utilizando da hierarquia para compartilhar c√≥digo
Como voc√™ pode perceber, Essa natureza hierarquica


#### Reutiliza√ß√£o de C√≥digo Entre Plataformas
O Kotlin Multiplatform permite a reutiliza√ß√£o eficiente do c√≥digo entre *source sets* espec√≠ficos de plataformas. Isso significa que a l√≥gica de neg√≥cios reutiliz√°vel e partes da interface do usu√°rio podem ser desenvolvidas uma √∫nica vez e usadas em diferentes plataformas, economizando tempo e esfor√ßos de desenvolvimento&#8203;``„Äêoaicite:7„Äë``&#8203;.

### Desenvolvimento de APIs Espec√≠ficas de Plataforma
Utilizando o mecanismo de declara√ß√µes *expected* e *actual*, o Kotlin Multiplatform oferece uma maneira eficaz de definir e acessar APIs espec√≠ficas da plataforma no c√≥digo comum. Isso permite que tarefas comuns sejam especializadas e otimizadas para cada plataforma, aumentando a efici√™ncia e a efic√°cia do c√≥digo&#8203;``„Äêoaicite:6„Äë``&#8203;.

### Suporte de Ferramentas e Integra√ß√£o com o Gradle
O IntelliJ IDEA, da JetBrains, oferece suporte integrado para a programa√ß√£o multiplataforma em Kotlin. Al√©m disso, o plugin `kotlin-multiplatform` do Gradle ajuda a configurar projetos multiplataforma, facilitando a gest√£o de *source sets* e depend√™ncias&#8203;``„Äêoaicite:5„Äë``&#8203;.

### Mudan√ßas Recentes e Pr√°ticas Recomendadas
Com as atualiza√ß√µes constantes do Kotlin Multiplatform, √© vital estar ciente das mudan√ßas recentes, como a nova abordagem para alvos auto-gerados pelo Gradle e altera√ß√µes nos nomes das configura√ß√µes de compila√ß√£o. Isso garante que os projetos estejam em conformidade com as pr√°ticas atuais e evita problemas de compatibilidade&#8203;``„Äêoaicite:4„Äë``&#8203;&#8203;``„Äêoaicite:3„Äë``&#8203;&#8203;``„Äêoaicite:2„Äë``&#8203;.

### Suporte para Estrutura Hier√°rquica e API Obsoleta
O Kotlin tem introduzido suporte para estruturas de projeto hier√°rquicas, permitindo criar *source sets* intermedi√°rios entre o `commonMain` e os espec√≠ficos da plataforma. √â importante estar atento √†s APIs obsoletas e √†s propriedades do Gradle que est√£o sendo gradualmente descontinuadas, para garantir a estabilidade e a modernidade do projeto&#8203;``„Äêoaicite:1„Äë``&#8203;&#8203;``„Äêoaicite:0„Äë``&#8203;.


### Convenc√µes
O KMP √© extremamente flex√≠vel, nos possibilitando nomear nossos source sets com praticamente qualquer nome.

Por√©m, no decorrer dos anos, a comunidade foi adotando algumas conven√ß√µes, e o pr√≥prio KMP foi se adequando ao redor dessas conven√ß√µes tamb√©m, oferecendo algumas facilidades na configura√ß√£o do projeto. Vamos explorar as principais delas 

#### 1: Nomes utilizando "camelCase"
A comunidade geralmente adota a nomenclatura `cammelCase` para a defini√ß√£o dos source sets. 

#### 2: Sufixo "main"
O diret√≥rio `main` em projetos que utilizam linguagens da JVM, como Java e Kotlin, √© tradicionalmente usado para armazenar o c√≥digo-fonte principal da aplica√ß√£o. Este diret√≥rio √© parte de uma estrutura de pastas convencional, onde `main` geralmente cont√©m os pacotes e classes que implementam a l√≥gica principal do programa. 

Em projetos KMP, essa tradi√ß√£o foi levada adiante e se utiliza o `main` como sufixo para declarar nossos source sets: `commonMain`, `androidMain`, `nativeMain`, `desktopMain`, etc.

#### 3: C√≥digo compartilhado usando o `commonMain`
Esse source set √© o "topo" da hierarquia






## Source Sets Espec√≠ficos de Plataforma
- O Kotlin cria *source sets* espec√≠ficos da plataforma, conhecidos como *platform source sets*. Cada alvo (target) tem um *source set* correspondente que compila apenas para esse alvo. Por exemplo, um alvo `jvm` ter√° o *source set* correspondente `jvmMain`&#8203;``„Äêoaicite:7„Äë``&#8203;.
- Durante a compila√ß√£o para um alvo espec√≠fico, o Kotlin coleta todos os *source sets* rotulados com esse alvo e produz bin√°rios a partir deles. Por exemplo, para o alvo JVM, ele seleciona `jvmMain` e `commonMain` e compila ambos juntos para os arquivos de classe JVM&#8203;``„Äêoaicite:6„Äë``&#8203;.

## Intermediate Source Sets
- Em projetos mais complexos, pode ser necess√°rio um compartilhamento de c√≥digo mais granular. Para isso, o Kotlin suporta *intermediate source sets*, que compilam para alguns, mas n√£o todos, os alvos no projeto. Isso √© √∫til para compartilhar c√≥digo entre um subconjunto de alvos&#8203;``„Äêoaicite:5„Äë``&#8203;.

## Integra√ß√£o com Testes
- Todos os *source sets* criados por padr√£o t√™m os prefixos `Main` e `Test`. O `Main` cont√©m c√≥digo de produ√ß√£o, enquanto o `Test` cont√©m testes para esse c√≥digo. Por exemplo, `commonTest` √© um *source set* de teste para `commonMain` e compila para todos os alvos declarados&#8203;``„Äêoaicite:4„Äë``&#8203;.

## Reutiliza√ß√£o de C√≥digo entre Plataformas
- O Kotlin multiplataforma organiza o c√≥digo-fonte em hierarquias, facilitando a reutiliza√ß√£o de c√≥digo entre *source sets*. Todos os *source sets* espec√≠ficos de plataforma dependem do *source set* comum por padr√£o&#8203;``„Äêoaicite:3„Äë``&#8203;.

## Desenvolvimento de APIs Espec√≠ficas de Plataforma
- Em alguns casos, √© desej√°vel definir e acessar APIs espec√≠ficas da plataforma no c√≥digo comum. Para isso, o Kotlin oferece o mecanismo de declara√ß√µes *expected* e *actual*. Uma fun√ß√£o pode ser declarada como *expected* no *source set* comum, e os *source sets* espec√≠ficos da plataforma devem fornecer uma implementa√ß√£o *actual* correspondente&#8203;``„Äêoaicite:2„Äë``&#8203;.

## Suporte de Ferramentas
- O IntelliJ IDEA, da JetBrains, oferece suporte integrado para programa√ß√£o multiplataforma, incluindo v√°rios modelos de projeto para criar projetos multiplataforma em Kotlin. Al√©m disso, o plugin `kotlin-multiplatform` do Gradle √© aplicado automaticamente, configurando o projeto para funcionar em v√°rias plataformas&#8203;``„Äêoaicite:1„Äë``&#8203;.

## Configura√ß√µes do Gradle
- Cada alvo pode ter uma ou mais compila√ß√µes. Os projetos Kotlin multiplataforma usam compila√ß√µes para produzir artefatos, e as compila√ß√µes padr√£o incluem `main` e `test` para alvos JVM, JS e Nativo&#8203;``„Äêoaicite:0„Äë``&#8203;.

## Conclus√£o
Os *source sets* no Kotlin s√£o uma ferramenta poderosa para o desenvolvimento multiplataforma, permitindo a separa√ß√£o e reutiliza√ß√£o eficiente do c√≥digo entre diferentes plataformas e contextos dentro de um projeto. Eles s√£o essenciais para a organiza√ß√£o e a modularidade em projetos Kotlin multiplataforma.


## Feedbacks

üîó [Nova issue no reposit√≥rio KMP-101](https://github.com/rsicarelli/KMP101/issues/new/choose)

Sua opini√£o e contribui√ß√£o fazem desse conte√∫do uma fonte de aprendizado mais completo para todo mundo!

Qualquer d√∫vida, cr√≠tica ou sugest√£o podem ser feitas no reposit√≥rio [KMP-101](https://github.com/rsicarelli/KMP101)


> Referencias
